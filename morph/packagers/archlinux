#!/bin/sh

package() { 
    info "Creating package..."
    workdir=$(mktemp -d /tmp/morph-mpkg.XXXXXXXX)
    cd $workdir

    cp -R $pkgdir/* .

    info "Generating meta..."
    cat > .PKGINFO <<HERE
# Generated by morph
pkgname = $name
pkgver = $version-$mbuild
pkgdesc = $description
builddate = $(date -u "+%s")
packager = $maintainer_name
size = $(du . -d0 | grep "[0-9]*" -o)"
arch = $target_arch
HERE
    pkgs=""
    info "Lost of pacman queries..."
    for item in $depfiles; do
        pkgs="$pkgs $(LC_ALL=C pacman -Qo $item | sed "s/.*is owned by //" | cut "-d " -f1)"
    done
    pkgs=$(echo $pkgs | tr " " "\n" | sort | uniq | tr "\n" " ")
    for item in $pkgs; do
        echo "depend = $item" >> .PKGINFO
    done
    pkgfile=$package_out_dir/$name-$version-$arch-$mbuild.pkg.tar.xz
    tar cJf $pkgfile .PKGINFO *
    info "Created package $pkgfile!"
    rm -rf $workdir
}

